#' Reshaping Multiple Time Series
#' @param x any time series object
#' @param ... arguments passed to subfuntions (ignored)
#' @export
ts_gather <- function (x, ...) UseMethod("ts_gather")

#' @export
#' @name ts_gather
#' @method ts_gather ts
ts_gather.ts <- function(x, ...){
  x
}

#' @export
#' @name ts_gather
#' @method ts_gather xts
ts_gather.xts <- function(x, ...){
  x
}

#' @export
#' @name ts_gather
#' @method ts_gather data.frame
ts_gather.data.frame <- function(x, ...){
  ts_data.frame(gather_core(as.data.table(x), ...))
}

#' @export
#' @name ts_gather
#' @method ts_gather data.table
ts_gather.data.table <- function(x, ...){
  ts_data.table(gather_core(x, ...))
}


#' @export
#' @name ts_gather
#' @method ts_gather tbl
ts_gather.tbl <- function(x, ...){
  ts_data.table(gather_core(as.data.table(x), ...))
}



gather_core <- function(x){
  stopifnot(inherits(x, "data.table"))
  time.name <- guess_time(x)
  z <- melt(x, id.vars = time.name, variable.name = "id", variable.factor = FALSE)
  ts_dts(z)
}






#' @export
#' @name ts_gather
ts_spread <- function (x, ...) UseMethod("ts_spread")

#' @export
#' @name ts_gather
#' @method ts_spread ts
ts_spread.ts <- function(x, ...){
  x
}

#' @export
#' @name ts_gather
#' @method ts_spread xts
ts_spread.xts <- function(x, ...){
  x
}

#' @export
#' @name ts_gather
#' @method ts_spread data.frame
ts_spread.data.frame <- function(x, ...){
  ts_data.frame(ts_spread(ts_dts(x), ...))
}

#' @export
#' @name ts_gather
#' @method ts_spread data.table
ts_spread.data.table <- function(x, ...){
  ts_data.table(ts_spread(ts_dts(x), ...))
}


#' @export
#' @name ts_gather
#' @method ts_spread tbl
ts_spread.tbl <- function(x, ...){
  ts_data.table(ts_spread(ts_dts(x), ...))
}

#' @export
#' @name ts_gather
#' @method ts_spread dts
ts_spread.dts <- function(x, ...){
  spread_core(x)
  # ts_data.table(ts_spread(ts_dts(x), ...))
}


spread_core <- function(x) {
  stopifnot(inherits(x, "dts"))

  if (ncol(x) == 2) return(x)  # nothing to do

  # no multi id 
  stopifnot(ncol(x) == 3)

  value.name <- colnames(x)[3]
  time.name <- colnames(x)[2]
  id.name <- colnames(x)[1]

  # in a dts, time is always at last position, so no guessing needed
  z <- dcast(x, as.formula(paste(time.name, "~", id.name)), 
             value.var = value.name)
  # keep order as in input
  setcolorder(z, c(time.name, unique(as.character(x[[id.name]]))))
  z
}


